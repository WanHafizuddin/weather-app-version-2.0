<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather App</title>
  <!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<link rel="stylesheet" href="style.css">

<body>
  <div class="app-container">
    <div class="sidebar">
      <h2>Weather Map</h2>
      <div id="map"></div>
    </div>

    <div class="weather-container">
      <div class="weather-searchbar">
        <input type="text" id="city-input" placeholder="Enter city" onkeypress="handleEnter(event)">
        <button onclick="fetchData()">Get Weather</button>
      </div>
      <div class="weather-info">
        <h1 id="city-name">Select a city</h1>
        <h1 id="weather-icon" style="font-size: 4rem; margin: 0;">üó∫Ô∏è</h1>
        <h2 id="temp-display">--</h2>
        <h3 id="weather-desc">Click map to view weather</h3>
      </div>
    </div>
  </div>

  <script>
    const cities = [
      { name: 'Johor Bahru', lat: 1.4927, lon: 103.7414 },
      { name: 'Alor Setar', lat: 6.1248, lon: 100.3678 },
      { name: 'Kota Bharu', lat: 6.1254, lon: 102.2381 },
      { name: 'Melaka', lat: 2.1896, lon: 102.2501 },
      { name: 'Seremban', lat: 2.7258, lon: 101.9424 },
      { name: 'Kuantan', lat: 3.8077, lon: 103.3260 },
      { name: 'George Town', lat: 5.4141, lon: 100.3288 },
      { name: 'Ipoh', lat: 4.5975, lon: 101.0901 },
      { name: 'Kangar', lat: 6.4368, lon: 100.1986 },
      { name: 'Kota Kinabalu', lat: 5.9804, lon: 116.0735 },
      { name: 'Kuching', lat: 1.5533, lon: 110.3592 },
      { name: 'Shah Alam', lat: 3.0738, lon: 101.5183 },
      { name: 'K. Terengganu', lat: 5.3117, lon: 103.1324 }, // K. Terengganu for display
      { name: 'Kuala Lumpur', lat: 3.1390, lon: 101.6869 },
      { name: 'Putrajaya', lat: 2.9264, lon: 101.6964 },
      { name: 'Labuan', lat: 5.2831, lon: 115.2308 }
    ];

    let map;

    function initMap() {
      // Center on Malaysia
      map = L.map('map').setView([4.2105, 101.9758], 6);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      updateMapWeather();
    }

    function getWeatherEmoji(description) {
      const desc = description.toLowerCase();
      if (desc.includes('clear')) return '‚òÄÔ∏è';
      if (desc.includes('clouds')) return '‚òÅÔ∏è';
      if (desc.includes('cloud')) return '‚òÅÔ∏è';
      if (desc.includes('rain')) return 'üåßÔ∏è';
      if (desc.includes('drizzle')) return 'üå¶Ô∏è';
      if (desc.includes('thunderstorm')) return '‚õàÔ∏è';
      if (desc.includes('snow')) return '‚ùÑÔ∏è';
      if (desc.includes('mist') || desc.includes('fog') || desc.includes('haze') || desc.includes('smoke')) return 'üå´Ô∏è';
      if (desc.includes('tornado')) return 'üå™Ô∏è';
      return 'üå°Ô∏è';
    }

    async function fetchCity(city) {
      document.getElementById("city-input").value = city;
      fetchData();
    }

    function handleEnter(e) {
      if (e.key === 'Enter') fetchData();
    }

    async function fetchData() {
      const city = document.getElementById("city-input").value;
      if (!city) return;

      const url = `/weather?city=${city}`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("Could not fetch data");

        const data = await response.json();

        const cityNameEl = document.getElementById("city-name");
        const weatherIconEl = document.getElementById("weather-icon");
        const tempDisplayEl = document.getElementById("temp-display");
        const weatherDescEl = document.getElementById("weather-desc");

        if (cityNameEl) {
          const tempInC = (data.main.temp - 273.15).toFixed(1);
          const desc = data.weather[0].description;

          cityNameEl.textContent = data.name;
          weatherIconEl.textContent = getWeatherEmoji(desc);
          tempDisplayEl.textContent = `${tempInC}¬∞C`;
          weatherDescEl.textContent = desc.charAt(0).toUpperCase() + desc.slice(1);

          // Zoom map to city
          if (map && data.coord) {
            map.setView([data.coord.lat, data.coord.lon], 12);


          }
        }
      } catch (error) {
        console.error("Error: ", error);
        alert("City not found or error fetching data");
      }
    }

    async function updateMapWeather() {
      for (const city of cities) {
        // Use exact name for query, handle K. Terengganu special case if needed for API
        const queryName = city.name === 'K. Terengganu' ? 'Kuala Terengganu' : city.name;

        try {
          const response = await fetch(`/weather?city=${queryName}`);
          if (response.ok) {
            const data = await response.json();
            const tempInC = (data.main.temp - 273.15).toFixed(0);
            const desc = data.weather[0].description;
            const emoji = getWeatherEmoji(desc);

            // Custom Icon
            const customIcon = L.divIcon({
              className: 'weather-marker',
              html: `<div class="weather-marker-content" style='font-size: 24px;'>${emoji}<br><span style='font-size: 12px; font-weight: bold; background: rgba(255,255,255,0.7); padding: 2px 5px; border-radius: 5px; white-space: nowrap; color: #333;'>${tempInC}¬∞C</span></div>`,
              iconSize: [50, 50],
              iconAnchor: [25, 25]
            });

            // Add marker
            const marker = L.marker([city.lat, city.lon], { icon: customIcon }).addTo(map);

            // Interaction: Click marker to search
            marker.on('click', () => {
              fetchCity(queryName);
            });

            // Optional: Tooltip on hover
            marker.bindTooltip(`${city.name}: ${tempInC}¬∞C`, { direction: 'top' });
          }
        } catch (e) {
          console.error(`Failed to load weather for ${city.name}`, e);
        }
      }
    }

    // Initial load
    window.onload = () => {
      initMap();
    };
  </script>
</body>

</html>